# SendGrid Setup for AIME Planner

This document explains how to configure SendGrid for the AIME Planner chatbot system.

## Overview

The AIME Planner uses SendGrid for outbound email delivery and inbound email processing through their Parse API. This setup allows the system to:

1. Send professional emails to vendors using SendGrid's delivery infrastructure
2. Receive vendor responses through SendGrid's inbound parse webhook
3. Route parsed emails to AWS SES/SNS for processing

## SendGrid Configuration

### 1. API Key Setup

1. Log into your SendGrid account
2. Go to Settings > API Keys
3. Create a new API key with the following permissions:
   - Mail Send: Full Access
   - Inbound Parse: Read Access
   - Email Activity: Read Access

4. Save the API key in your environment variables:
   ```bash
   SENDGRID_API_KEY=SG.your_api_key_here
   ```

### 2. Domain Authentication

1. Go to Settings > Sender Authentication
2. Authenticate your domain (groupize.com)
3. Add the required DNS records:
   - CNAME records for domain verification
   - TXT records for SPF/DKIM

### 3. Inbound Parse Setup

#### Configure Inbound Parse Webhook

1. Go to Settings > Inbound Parse
2. Add a new hostname: `aime-{environment}.groupize.com`
3. Set the destination URL based on your environment:

**Testing Environment:**
```
https://your-api-gateway-url.execute-api.us-east-1.amazonaws.com/testing/process-email
```

**Staging Environment:**
```
https://your-api-gateway-url.execute-api.us-east-1.amazonaws.com/staging/process-email
```

**Production Environment:**
```
https://your-api-gateway-url.execute-api.us-east-1.amazonaws.com/production/process-email
```

#### DNS Configuration

Add MX records to your DNS for each environment:

```
# Testing
aime-testing.groupize.com.    MX    10    mx.sendgrid.net.

# Staging
aime-staging.groupize.com.    MX    10    mx.sendgrid.net.

# Production
aime-production.groupize.com. MX    10    mx.sendgrid.net.
```

## Email Flow Architecture

```
1. AIME Lambda → SendGrid API → Vendor Email
2. Vendor Reply → SendGrid Parse → API Gateway → Process Email Lambda
```

### Outbound Email Flow

1. **Initiate Bid Lambda** generates email content using LLM
2. Email is sent via SendGrid API with:
   - From: `aime-{environment}@groupize.com`
   - Reply-To: `aime-{environment}+{conversation_id}@groupize.com`
   - Professional content generated by OpenAI

### Inbound Email Flow

1. Vendor replies to the email
2. SendGrid receives the email at `aime-{environment}+{conversation_id}@groupize.com`
3. SendGrid Parse webhook posts to API Gateway
4. **Process Email Lambda** parses the response using LLM
5. Conversation state is updated in DynamoDB
6. Follow-up emails are sent if needed

## Configuration Examples

### Environment-Specific Settings

#### Testing Environment
```json
{
  "hostname": "aime-testing.groupize.com",
  "url": "https://abcd1234.execute-api.us-east-1.amazonaws.com/testing/process-email",
  "spam_check": true,
  "send_raw": false
}
```

#### Production Environment
```json
{
  "hostname": "aime-production.groupize.com",
  "url": "https://prod5678.execute-api.us-east-1.amazonaws.com/production/process-email",
  "spam_check": true,
  "send_raw": false
}
```

## Testing SendGrid Integration

### 1. Test Outbound Email

```bash
# Send test email via API
curl -X POST https://your-api-gateway-url/testing/initiate-bid \
  -H "Content-Type: application/json" \
  -d @test-data/sample-request.json
```

### 2. Test Inbound Parse

1. Send an email to: `aime-testing+test-conversation-id@groupize.com`
2. Check CloudWatch logs for the Process Email Lambda
3. Verify the email was parsed and processed correctly

### 3. Monitor Email Delivery

Use SendGrid's Email Activity dashboard to monitor:
- Delivery rates
- Bounce rates
- Spam reports
- Click/open rates

## Troubleshooting

### Common Issues

1. **DNS Propagation**
   - MX records may take up to 24 hours to propagate
   - Use `dig MX aime-testing.groupize.com` to verify

2. **Webhook Authentication**
   - Ensure API Gateway accepts POST requests
   - Verify CORS settings if needed
   - Check CloudWatch logs for 4xx/5xx errors

3. **Email Delivery Issues**
   - Verify domain authentication is complete
   - Check sender reputation in SendGrid
   - Review bounce/spam reports

### Monitoring Commands

```bash
# Check recent Lambda invocations
aws logs tail /aws/lambda/testing-aime-process-email --follow

# Check SendGrid webhook attempts
curl -H "Authorization: Bearer $SENDGRID_API_KEY" \
  "https://api.sendgrid.com/v3/user/webhooks/parse/stats"

# Test DNS resolution
dig MX aime-testing.groupize.com
```

## Security Considerations

1. **Webhook Verification**
   - Implement webhook signature verification
   - Use HTTPS endpoints only
   - Rate limit webhook requests

2. **Email Content**
   - Sanitize all user inputs
   - Validate email addresses
   - Implement content filtering

3. **API Key Security**
   - Store API keys in AWS Secrets Manager
   - Use least-privilege permissions
   - Rotate keys regularly

## Production Deployment Checklist

- [ ] Domain authentication completed
- [ ] MX records configured and propagated
- [ ] Inbound parse webhook configured
- [ ] Test emails sent and received successfully
- [ ] Monitoring and alerting set up
- [ ] Error handling tested
- [ ] Spam/abuse monitoring configured
- [ ] Backup email routing configured
